services:
  # Dienst 1: Der NonPlusUltra Bot (Hintergrund-Dienst)
  - type: worker
    name: nonplusultra-bot
    env: python
    buildCommand: "pip install -r requirements.txt"
    startCommand: "python main.py"
    envVars:
      - key: PYTHON_VERSION
        value: 3.12.1
      - fromGroup: nonplusultra-secrets
      - key: REDIS_URL
        fromService:
          type: redis
          name: bot-redis
          property: connectionString
      # ## NEUE LOGIK ##
      # Sage dem Bot, wo er die hochgeladene Schlüssel-Datei finden kann
      - key: GOOGLE_APPLICATION_CREDENTIALS
        fromSecretFile:
          name: google_credentials.json
          path: /etc/secrets/google_credentials.json

  # Dienst 2: Redis-Instanz
  - type: redis
    name: bot-redis
    plan: free
    ipAllowList:
      - source: 0.0.0.0/0
        description: "Allow all"
    maxmemoryPolicy: allkeys-lfu

# Umgebungsvariablen-Gruppe
envVarGroups:
  - name: nonplusultra-secrets
    envVars:
      - key: QUICKNODE_RPC_URL
        sync: false
      - key: QUICKNODE_WSS_URL
        sync: false
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: TELEGRAM_CHAT_ID
        sync: false
      - key: GOOGLE_CLOUD_PROJECT
        sync: false
      - key: UPSTASH_REDIS_URL
        sync: false
      # Die alte JSON-Variable wird hier nicht mehr benötigt